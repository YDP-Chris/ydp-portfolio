<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FretFlow - See scales, feel the music</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fret-dot {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }
        .fret-dot:hover {
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
        }
        .fret-dot:focus {
            outline: 3px solid #fbbf24;
            outline-offset: 2px;
        }
        .fret-dot.active {
            animation: pulse 0.5s ease-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
            50% { transform: scale(1.3); box-shadow: 0 0 40px rgba(251, 191, 36, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
        }
        .trail-dot {
            animation: trail 2s ease-out forwards;
        }
        @keyframes trail {
            0% { box-shadow: 0 0 40px rgba(251, 191, 36, 1); }
            100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
        }
        .fretboard-bg {
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
        }
        .error-message {
            background-color: #7f1d1d;
            color: #fca5a5;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const FretFlow = () => {
            const [currentScaleIndex, setCurrentScaleIndex] = useState(0);
            const [playedNotes, setPlayedNotes] = useState([]);
            const [showNoteName, setShowNoteName] = useState({ show: false, note: '', fret: null, string: null });
            const [audioError, setAudioError] = useState(null);
            const [isAudioSupported, setIsAudioSupported] = useState(true);
            const audioContextRef = useRef(null);
            
            // Scale patterns (fret positions for each string)
            const scales = {
                'C Major': {
                    pattern: [
                        [0, 3, 5, 7, 10], // Low E string
                        [1, 3, 5, 8, 10], // A string
                        [0, 2, 5, 7, 9],  // D string
                        [0, 2, 4, 7, 9],  // G string
                        [1, 3, 5, 8, 10], // B string
                        [0, 3, 5, 7, 10]  // High E string
                    ],
                    notes: [
                        ['E', 'G', 'A', 'B', 'D'], // Low E string (E, G, A, B, D)
                        ['A#', 'C', 'D', 'F', 'G'], // A string (A#, C, D, F, G)
                        ['D', 'E', 'G', 'A', 'C'],  // D string (D, E, G, A, C)
                        ['G', 'A', 'B', 'D', 'E'],  // G string (G, A, B, D, E)
                        ['C', 'D', 'E', 'G', 'A'],  // B string (C, D, E, G, A)
                        ['E', 'G', 'A', 'B', 'D']   // High E string (E, G, A, B, D)
                    ]
                },
                'A Minor': {
                    pattern: [
                        [0, 3, 5, 7, 10],
                        [0, 2, 3, 5, 7],
                        [0, 2, 5, 7, 9],
                        [0, 2, 5, 7, 9],
                        [1, 3, 5, 8, 10],
                        [0, 3, 5, 8, 10]
                    ],
                    notes: [
                        ['E', 'G', 'A', 'B', 'D'], // Low E string
                        ['A', 'B', 'C', 'D', 'E'], // A string
                        ['D', 'E', 'G', 'A', 'C'], // D string
                        ['G', 'A', 'C', 'D', 'E'], // G string
                        ['C', 'D', 'E', 'G', 'A'], // B string
                        ['E', 'G', 'A', 'B', 'D']  // High E string
                    ]
                },
                'G Major': {
                    pattern: [
                        [2, 3, 5, 7, 10],
                        [0, 2, 3, 5, 7],
                        [0, 2, 4, 7, 9],
                        [0, 2, 4, 7, 9],
                        [0, 3, 5, 7, 8],
                        [2, 3, 5, 7, 10]
                    ],
                    notes: [
                        ['F#', 'G', 'A', 'B', 'D'], // Low E string
                        ['A', 'B', 'C', 'D', 'E'],  // A string
                        ['D', 'E', 'F#', 'A', 'B'], // D string (corrected)
                        ['G', 'A', 'B', 'D', 'E'],  // G string
                        ['B', 'D', 'E', 'F#', 'G'], // B string (corrected)
                        ['F#', 'G', 'A', 'B', 'D']  // High E string
                    ]
                }
            };
            
            const scaleNames = Object.keys(scales);
            const currentScaleData = scales[scaleNames[currentScaleIndex]];
            
            // Initialize Web Audio API with error handling
            useEffect(() => {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) {
                        setIsAudioSupported(false);
                        setAudioError('Web Audio API not supported in this browser');
                        return;
                    }
                    audioContextRef.current = new AudioContext();
                } catch (error) {
                    console.error('Failed to initialize audio context:', error);
                    setIsAudioSupported(false);
                    setAudioError('Failed to initialize audio. Audio features will be disabled.');
                }
            }, []);
            
            // Play note function with error handling
            const playNote = (frequency) => {
                if (!audioContextRef.current || !isAudioSupported) {
                    console.warn('Audio not available');
                    return;
                }
                
                try {
                    const oscillator = audioContextRef.current.createOscillator();
                    const gainNode = audioContextRef.current.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContextRef.current.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContextRef.current.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContextRef.current.currentTime + 0.5);
                    
                    oscillator.start(audioContextRef.current.currentTime);
                    oscillator.stop(audioContextRef.current.currentTime + 0.5);
                } catch (error) {
                    console.error('Failed to play note:', error);
                }
            };
            
            // Get frequency for note using equal temperament tuning
            const getNoteFrequency = (stringIndex, fretIndex) => {
                // Standard guitar tuning frequencies (Hz)
                const baseFreqs = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63]; // E A D G B E
                const fret = currentScaleData.pattern[stringIndex][fretIndex];
                // Each fret is a semitone higher: frequency * 2^(semitones/12)
                return baseFreqs[stringIndex] * Math.pow(2, fret / 12);
            };
            
            // Handle fret tap with keyboard support
            const handleFretTap = (stringIndex, fretIndex) => {
                // Resume audio context on user interaction
                if (audioContextRef.current && audioContextRef.current.state === 'suspended') {
                    audioContextRef.current.resume().catch(error => {
                        console.error('Failed to resume audio context:', error);
                    });
                }
                
                const frequency = getNoteFrequency(stringIndex, fretIndex);
                const note = currentScaleData.notes[stringIndex][fretIndex];
                
                playNote(frequency);
                
                // Show note name
                setShowNoteName({ show: true, note, fret: fretIndex, string: stringIndex });
                setTimeout(() => setShowNoteName({ show: false, note: '', fret: null, string: null }), 800);
                
                // Add to played notes for melody detection
                const newNote = { stringIndex, fretIndex, timestamp: Date.now() };
                setPlayedNotes(prev => [...prev.slice(-4), newNote]);
                
                // Trigger active animation
                const dotElement = document.getElementById(`dot-${stringIndex}-${fretIndex}`);
                if (dotElement) {
                    dotElement.classList.add('active');
                    setTimeout(() => dotElement.classList.remove('active'), 500);
                }
            };
            
            // Handle keyboard events
            const handleKeyDown = (event, stringIndex, fretIndex) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    handleFretTap(stringIndex, fretIndex);
                }
            };
            
            // Detect melody and create trail effect
            useEffect(() => {
                if (playedNotes.length >= 3) {
                    const recentNotes = playedNotes.slice(-3);
                    const timeDiffs = recentNotes.map((note, i) => 
                        i > 0 ? note.timestamp - recentNotes[i-1].timestamp : 0
                    ).slice(1);
                    
                    // If notes played in quick succession (melody detected)
                    if (timeDiffs.every(diff => diff < 1000)) {
                        recentNotes.forEach((note, i) => {
                            setTimeout(() => {
                                const dotElement = document.getElementById(`dot-${note.stringIndex}-${note.fretIndex}`);
                                if (dotElement) {
                                    dotElement.classList.add('trail-dot');
                                    setTimeout(() => dotElement.classList.remove('trail-dot'), 2000);
                                }
                            }, i * 100);
                        });
                    }
                }
            }, [playedNotes]);
            
            // Change scale
            const changeScale = (direction) => {
                const newIndex = direction === 'next' 
                    ? (currentScaleIndex + 1) % scaleNames.length
                    : (currentScaleIndex - 1 + scaleNames.length) % scaleNames.length;
                setCurrentScaleIndex(newIndex);
                setPlayedNotes([]);
            };
            
            // Touch handlers for swipe (only on fretboard area)
            let touchStartX = 0;
            const handleTouchStart = (e) => {
                touchStartX = e.touches[0].clientX;
            };
            
            const handleTouchEnd = (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > 100) { // Increased threshold to prevent accidental swipes
                    e.preventDefault();
                    changeScale(diff > 0 ? 'next' : 'prev');
                }
            };
            
            return (
                <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-4">
                    {/* Header */}
                    <div className="text-center mb-8">
                        <h1 className="text-3xl font-bold text-yellow-300 mb-2">FretFlow</h1>
                        <p className="text-gray-300 text-sm mb-4">See scales, feel the music</p>
                        <div className="text-yellow-200 text-xl font-semibold" role="status" aria-live="polite">
                            {scaleNames[currentScaleIndex]}
                        </div>
                        <p className="text-gray-400 text-xs mt-2">Swipe left/right on fretboard to change scales</p>
                    </div>
                    
                    {/* Error message */}
                    {audioError && (
                        <div className="error-message max-w-md text-center" role="alert">
                            <strong>Audio Notice:</strong> {audioError}
                        </div>
                    )}
                    
                    {/* Fretboard */}
                    <div className="fretboard-bg rounded-lg p-6 shadow-2xl max-w-4xl w-full"
                         onTouchStart={handleTouchStart}
                         onTouchEnd={handleTouchEnd}
                         role="application"
                         aria-label={`Guitar fretboard showing ${scaleNames[currentScaleIndex]} scale`}>
                        <div className="space-y-4">
                            {currentScaleData.pattern.map((string, stringIndex) => {
                                const stringNames = ['Low E', 'A', 'D', 'G', 'B', 'High E'];
                                return (
                                    <div key={stringIndex} className="relative">
                                        {/* String line */}
                                        <div className="absolute top-1/2 left-0 right-0 h-0.5 bg-gray-300 transform -translate-y-1/2" 
                                             aria-hidden="true"></div>
                                        
                                        {/* String label for screen readers */}
                                        <div className="sr-only">{stringNames[stringIndex]} string</div>
                                        
                                        {/* Fret dots */}
                                        <div className="flex justify-between items-center py-2 relative z-10">
                                            {string.map((fret, fretIndex) => (
                                                <button
                                                    key={fretIndex}
                                                    id={`dot-${stringIndex}-${fretIndex}`}
                                                    className="fret-dot w-8 h-8 md:w-10 md:h-10 bg-yellow-400 rounded-full flex items-center justify-center text-gray-900 font-bold text-xs hover:scale-110 active:scale-95 transition-transform"
                                                    onClick={() => handleFretTap(stringIndex, fretIndex)}
                                                    onKeyDown={(e) => handleKeyDown(e, stringIndex, fretIndex)}
                                                    aria-label={`Play ${currentScaleData.notes[stringIndex][fretIndex]} note on ${stringNames[stringIndex]} string, fret ${fret}`}
                                                    tabIndex={0}
                                                >
                                                    {showNoteName.show && 
                                                     showNoteName.string === stringIndex && 
                                                     showNoteName.fret === fretIndex ? (
                                                        <span className="animate-pulse" aria-live="polite">
                                                            {showNoteName.note}
                                                        </span>
                                                    ) : (
                                                        <span className="opacity-70 md:opacity-50 hover:opacity-100 text-xs">
                                                            {currentScaleData.notes[stringIndex][fretIndex]}
                                                        </span>
                                                    )}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    {/* Instructions */}
                    <div className="mt-8 text-center max-w-md">
                        <p className="text-yellow-300 text-lg font-medium mb-2">
                            {isAudioSupported ? 'Tap any fret to hear the note' : 'Tap any fret to see the note'}
                        </p>
                        <p className="text-gray-300 text-sm">Play a sequence to create a melody trail ✨</p>
                        <p className="text-gray-400 text-xs mt-2">Use Tab and Enter/Space for keyboard navigation</p>
                    </div>
                    
                    {/* Scale navigation */}
                    <div className="mt-6 flex items-center space-x-4">
                        <button 
                            onClick={() => changeScale('prev')}
                            className="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 focus:bg-yellow-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 rounded-lg text-black font-medium transition-colors"
                            aria-label="Previous scale"
                        >
                            ← Prev Scale
                        </button>
                        <button 
                            onClick={() => changeScale('next')}
                            className="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 focus:bg-yellow-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 rounded-lg text-black font-medium transition-colors"
                            aria-label="Next scale"
                        >
                            Next Scale →
                        </button>
                    </div>
                    
                    {/* Footer */}
                    <div className="mt-12 text-center text-gray-400 text-xs">
                        Built with ❤️ by Foundry
                    </div>
                </div>
            );
        };
        
        ReactDOM.render(<FretFlow />, document.getElementById('root'));
    </script>
</body>
</html>